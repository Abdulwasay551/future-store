{% extends 'inventory_erp/base.html' %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold">{% if sale %}Edit{% else %}New{% endif %} Sale Entry</h1>
        <a href="{% url 'inventory_erp:sale_list' %}" class="text-mc-white/70 hover:text-mc-white transition-colors duration-300">
            <i class="fas fa-arrow-left mr-2"></i>Back to List
        </a>
    </div>

    <form method="POST" class="max-w-5xl mx-auto" hx-post="{{ request.path }}" hx-swap="outerHTML">
        {% csrf_token %}
        <div class="bg-mc-grey/10 rounded-lg p-6 mb-8">
            <h2 class="text-lg font-semibold mb-4">Sale Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Customer Information -->
                <div>
                    <label for="customer_name" class="block text-sm font-medium mb-2">Customer Name</label>
                    <input type="text" name="customer_name" id="customer_name" 
                           value="{{ sale.customer_name|default:'' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                </div>

                <div>
                    <label for="customer_phone" class="block text-sm font-medium mb-2">Customer Phone</label>
                    <input type="tel" name="customer_phone" id="customer_phone" 
                           value="{{ sale.customer_phone|default:'' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                </div>

                <div>
                    <label for="customer_email" class="block text-sm font-medium mb-2">Customer Email</label>
                    <input type="email" name="customer_email" id="customer_email" 
                           value="{{ sale.customer_email|default:'' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent">
                </div>

                <div>
                    <label for="customer_cnic" class="block text-sm font-medium mb-2">Customer CNIC</label>
                    <input type="text" name="customer_cnic" id="customer_cnic" 
                           value="{{ sale.customer_cnic|default:'' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent"
                           pattern="[0-9]{5}-[0-9]{7}-[0-9]"
                           placeholder="00000-0000000-0">
                </div>

                <div>
                    <label for="sale_type" class="block text-sm font-medium mb-2">Sale Type</label>
                    <select name="sale_type" id="sale_type" 
                            class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" 
                            required>
                        <option value="retail" {% if sale.sale_type == 'retail' %}selected{% endif %}>Retail</option>
                        <option value="wholesale" {% if sale.sale_type == 'wholesale' %}selected{% endif %}>Wholesale</option>
                    </select>
                </div>

                <div id="subDealerGroup" class="{% if sale.sale_type != 'wholesale' %}hidden{% endif %}">
                    <label for="sub_dealer" class="block text-sm font-medium mb-2">Sub Dealer</label>
                    <select name="sub_dealer" id="sub_dealer" 
                            class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent">
                        <option value="">Select Sub Dealer</option>
                        {% for dealer in dealers %}
                        <option value="{{ dealer.id }}" {% if sale.sub_dealer_id == dealer.id %}selected{% endif %}>{{ dealer.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="sale_date" class="block text-sm font-medium mb-2">Sale Date</label>
                    <input type="date" name="sale_date" id="sale_date" 
                           value="{{ sale.sale_date|date:'Y-m-d'|default:today|date:'Y-m-d' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                </div>
            </div>
        </div>

        <div class="bg-mc-grey/10 rounded-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Items</h2>
                <button type="button" id="addItemBtn" 
                        class="px-4 py-2 bg-mc-accent hover:bg-mc-accent/80 rounded-lg transition-colors duration-300">
                    <i class="fas fa-plus mr-2"></i>Add Item
                </button>
            </div>

            <div id="itemsContainer" class="space-y-4">
                <!-- Item template will be cloned and inserted here -->
            </div>

            <template id="itemTemplate">
                <div class="item-row bg-mc-black/30 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Device</label>
                            <select name="device_id[]" class="device-select w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                                <option value="">Select Device</option>
                                {% for device in devices %}
                                <option value="{{ device.id }}" data-price="{{ device.price }}">{{ device.name }} - {{ device.company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Quantity</label>
                            <input type="number" name="quantity[]" min="1" value="1"
                                   class="quantity-input w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Unit Price</label>
                            <input type="number" name="unit_price[]" step="0.01" min="0"
                                   class="price-input w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Discount</label>
                            <input type="number" name="discount[]" step="0.01" min="0" value="0"
                                   class="discount-input w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                        </div>

                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium mb-2">Serial Numbers (one per line)</label>
                            <textarea name="serial_numbers[]" rows="2"
                                    class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent"></textarea>
                        </div>

                        <div class="flex items-end">
                            <button type="button" class="remove-item px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-500 rounded-lg transition-colors duration-300">
                                <i class="fas fa-trash mr-2"></i>Remove
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <div class="bg-mc-grey/10 rounded-lg p-6 mb-8">
            <h2 class="text-lg font-semibold mb-4">Payment Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="total_amount" class="block text-sm font-medium mb-2">Total Amount</label>
                    <input type="number" name="total_amount" id="total_amount" step="0.01" min="0" 
                           value="{{ sale.total_amount|default:'0.00' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" readonly>
                </div>

                <div>
                    <label for="discount" class="block text-sm font-medium mb-2">Total Discount</label>
                    <input type="number" name="discount" id="discount" step="0.01" min="0" 
                           value="{{ sale.discount|default:'0.00' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" readonly>
                </div>

                <div>
                    <label for="tax_amount" class="block text-sm font-medium mb-2">Tax Amount</label>
                    <input type="number" name="tax_amount" id="tax_amount" step="0.01" min="0" 
                           value="{{ sale.tax_amount|default:'0.00' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                </div>

                <div>
                    <label for="final_amount" class="block text-sm font-medium mb-2">Final Amount</label>
                    <input type="number" name="final_amount" id="final_amount" step="0.01" min="0" 
                           value="{{ sale.final_amount|default:'0.00' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" readonly>
                </div>

                <div>
                    <label for="received_amount" class="block text-sm font-medium mb-2">Received Amount</label>
                    <input type="number" name="received_amount" id="received_amount" step="0.01" min="0" 
                           value="{{ sale.received_amount|default:'0.00' }}"
                           class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" required>
                </div>

                <div>
                    <label for="payment_status" class="block text-sm font-medium mb-2">Payment Status</label>
                    <select name="payment_status" id="payment_status" 
                            class="w-full bg-mc-black border border-mc-grey/30 rounded-lg px-3 py-2 focus:outline-none focus:border-mc-accent" 
                            required>
                        <option value="paid" {% if sale.payment_status == 'paid' %}selected{% endif %}>Paid</option>
                        <option value="partial" {% if sale.payment_status == 'partial' %}selected{% endif %}>Partial</option>
                        <option value="pending" {% if sale.payment_status == 'pending' %}selected{% endif %}>Pending</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-4">
            <a href="{% url 'inventory_erp:sale_list' %}" class="px-6 py-2 rounded-lg bg-mc-grey/20 hover:bg-mc-grey/30 transition-colors duration-300">
                Cancel
            </a>
            <button type="submit" class="px-6 py-2 rounded-lg bg-mc-accent hover:bg-mc-accent/80 transition-colors duration-300">
                {% if sale %}Update{% else %}Create{% endif %} Sale
            </button>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('itemsContainer');
    const itemTemplate = document.getElementById('itemTemplate');
    const addItemBtn = document.getElementById('addItemBtn');
    const saleType = document.getElementById('sale_type');
    const subDealerGroup = document.getElementById('subDealerGroup');
    const subDealer = document.getElementById('sub_dealer');

    // Add new item row
    addItemBtn.addEventListener('click', function() {
        const newItem = itemTemplate.content.cloneNode(true);
        itemsContainer.appendChild(newItem);
        setupItemRow(itemsContainer.lastElementChild);
    });

    // Remove item row
    itemsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item') || e.target.closest('.remove-item')) {
            const itemRow = e.target.closest('.item-row');
            itemRow.remove();
            updateTotals();
        }
    });

    // Show/hide sub-dealer based on sale type
    saleType.addEventListener('change', function() {
        subDealerGroup.classList.toggle('hidden', this.value !== 'wholesale');
        if (this.value === 'wholesale') {
            subDealer.setAttribute('required', '');
        } else {
            subDealer.removeAttribute('required');
        }
    });

    // Setup event listeners for an item row
    function setupItemRow(row) {
        const deviceSelect = row.querySelector('.device-select');
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.price-input');
        const discountInput = row.querySelector('.discount-input');

        deviceSelect.addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            if (option.dataset.price) {
                priceInput.value = option.dataset.price;
            }
            updateTotals();
        });

        [quantityInput, priceInput, discountInput].forEach(input => {
            input.addEventListener('input', updateTotals);
        });
    }

    // Calculate totals
    function updateTotals() {
        let totalAmount = 0;
        let totalDiscount = 0;

        itemsContainer.querySelectorAll('.item-row').forEach(row => {
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const discount = parseFloat(row.querySelector('.discount-input').value) || 0;

            totalAmount += quantity * price;
            totalDiscount += discount;
        });

        document.getElementById('total_amount').value = totalAmount.toFixed(2);
        document.getElementById('discount').value = totalDiscount.toFixed(2);
        
        const taxAmount = parseFloat(document.getElementById('tax_amount').value) || 0;
        const finalAmount = totalAmount - totalDiscount + taxAmount;
        document.getElementById('final_amount').value = finalAmount.toFixed(2);
    }

    // Add first item row if none exist
    if (itemsContainer.children.length === 0) {
        addItemBtn.click();
    }

    // Update totals on tax amount change
    document.getElementById('tax_amount').addEventListener('input', updateTotals);
});
</script>
{% endblock %}
