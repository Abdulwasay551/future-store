{% extends "shared/skeleton.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8 text-mc-white">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-mc-white">Notifications</h1>
                <p class="text-mc-light-grey mt-2">Stay updated with your order status and important updates</p>
            </div>
            {% if unread_count > 0 %}
            <div class="flex items-center gap-4">
                <span class="bg-mc-accent text-mc-black px-3 py-1 rounded-full text-sm font-semibold">
                    {{ unread_count }} unread
                </span>
                <button onclick="markAllAsRead()" 
                        class="px-4 py-2 bg-mc-dark text-mc-white hover:bg-mc-grey/30 transition-colors duration-300 rounded-lg border border-mc-grey/30">
                    Mark all as read
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Notifications List -->
        <div class="space-y-4">
            {% for notification in notifications %}
            <div class="bg-mc-dark rounded-xl p-6 border border-mc-grey/30 transition-all duration-200 hover:border-mc-accent/50 {% if not notification.is_read %}border-l-4 border-l-mc-accent{% endif %}"
                 id="notification-{{ notification.id }}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-3 h-3 rounded-full {% if notification.is_read %}bg-mc-grey{% else %}bg-mc-accent{% endif %}"></div>
                            <span class="text-sm text-mc-light-grey">{{ notification.created_at|timesince }} ago</span>
                            {% if not notification.is_read %}
                            <span class="bg-mc-accent text-mc-black px-2 py-1 rounded-full text-xs font-semibold">New</span>
                            {% endif %}
                        </div>
                        
                        <h3 class="text-lg font-semibold text-mc-white mb-2">{{ notification.title }}</h3>
                        <p class="text-mc-light-grey leading-relaxed mb-4">{{ notification.message|linebreaks }}</p>
                        
                        {% if notification.order %}
                        <div class="bg-mc-black/50 rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-mc-white font-semibold">Order #{{ notification.order.id }}</p>
                                    <p class="text-mc-light-grey text-sm">Rs {{ notification.order.total_amount }}</p>
                                </div>
                                <div class="text-right">
                                    <span class="status-badge status-{{ notification.order.status }}">
                                        {{ notification.order.status_display }}
                                    </span>
                                    {% if notification.order.tracking_id %}
                                    <p class="text-mc-accent text-sm mt-1">Tracking: {{ notification.order.tracking_id }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="flex items-center gap-3">
                            {% if notification.order %}
                            <a href="{% url 'order_detail' notification.order.id %}" 
                               class="px-4 py-2 bg-mc-accent text-mc-black hover:bg-mc-accent/90 transition-colors duration-300 rounded-lg font-semibold">
                                View Order
                            </a>
                            {% endif %}
                            
                            {% if not notification.is_read %}
                            <button onclick="markAsRead({{ notification.id }})" 
                                    class="px-4 py-2 bg-mc-dark text-mc-white hover:bg-mc-grey/30 transition-colors duration-300 rounded-lg border border-mc-grey/30">
                                Mark as read
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12">
                <div class="w-24 h-24 bg-mc-grey/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-bell text-3xl text-mc-grey"></i>
                </div>
                <h3 class="text-xl font-semibold text-mc-white mb-2">No notifications yet</h3>
                <p class="text-mc-light-grey">You'll see order updates and important notifications here.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Load More Button -->
        {% if notifications.count >= 50 %}
        <div class="text-center mt-8">
            <button class="px-6 py-3 bg-mc-dark text-mc-white hover:bg-mc-grey/30 transition-colors duration-300 rounded-lg border border-mc-grey/30 font-semibold">
                Load More Notifications
            </button>
        </div>
        {% endif %}
    </div>
</div>

<style>
.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}
.status-pending { background-color: #fff3cd; color: #856404; }
.status-confirmed { background-color: #d1ecf1; color: #0c5460; }
.status-processing { background-color: #d4edda; color: #155724; }
.status-shipped { background-color: #cce5ff; color: #004085; }
.status-out_for_delivery { background-color: #e2e3e5; color: #383d41; }
.status-delivered { background-color: #d4edda; color: #155724; }
.status-cancelled { background-color: #f8d7da; color: #721c24; }
.status-returned { background-color: #f8d7da; color: #721c24; }
</style>
{% endblock %}

{% block extra_js %}
<script>
function markAsRead(notificationId) {
    fetch(`/store/notifications/mark-read/${notificationId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notification = document.getElementById(`notification-${notificationId}`);
                const dot = notification.querySelector('.w-3.h-3');
                const newBadge = notification.querySelector('.bg-mc-accent.text-mc-black');
                const markReadBtn = notification.querySelector('button');
                
                // Update visual indicators
                dot.classList.remove('bg-mc-accent');
                dot.classList.add('bg-mc-grey');
                
                if (newBadge) {
                    newBadge.remove();
                }
                
                if (markReadBtn) {
                    markReadBtn.remove();
                }
                
                // Remove left border
                notification.classList.remove('border-l-4', 'border-l-mc-accent');
                
                // Update unread count
                updateUnreadCount();
            }
        })
        .catch(error => {
            console.error('Error marking notification as read:', error);
        });
}

function markAllAsRead() {
    fetch('/store/notifications/mark-all-read/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update all notifications visually
                document.querySelectorAll('.bg-mc-accent.text-mc-black').forEach(badge => badge.remove());
                document.querySelectorAll('.w-3.h-3.bg-mc-accent').forEach(dot => {
                    dot.classList.remove('bg-mc-accent');
                    dot.classList.add('bg-mc-grey');
                });
                document.querySelectorAll('button[onclick^="markAsRead"]').forEach(btn => btn.remove());
                document.querySelectorAll('.border-l-4.border-l-mc-accent').forEach(notification => {
                    notification.classList.remove('border-l-4', 'border-l-mc-accent');
                });
                
                // Update unread count
                updateUnreadCount();
            }
        })
        .catch(error => {
            console.error('Error marking all notifications as read:', error);
        });
}

function updateUnreadCount() {
    const unreadBadge = document.querySelector('.bg-mc-accent.text-mc-black');
    if (unreadBadge) {
        const currentCount = parseInt(unreadBadge.textContent.split(' ')[0]);
        if (currentCount > 1) {
            unreadBadge.textContent = `${currentCount - 1} unread`;
        } else {
            unreadBadge.remove();
            document.querySelector('button[onclick="markAllAsRead()"]').remove();
        }
    }
}
</script>
{% endblock %} 